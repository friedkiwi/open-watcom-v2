# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- master

variables: {System.Debug: true, owazure_debug: 1}

stages:
  - stage: boot
    displayName: "Bootstrap"
    jobs:
      - job: Linux
        pool:
          vmImage: 'ubuntu-latest'
        variables:
          group: linux
        steps:
        - task: PublishPipelineArtifact@1
          inputs: {artifactName: $(owbindir), targetPath: build/$(owbindir)}
      - job: Windows
        pool:
          vmImage: 'vs2017-win2016'
        variables:
          group: windows
        steps:
        - task: PublishPipelineArtifact@1
          inputs: {artifactName: $(owbindir), targetPath: build/$(owbindir)}
      - job: OSX
        pool:
          vmImage: 'macOS-latest'
        steps:
        - task: PublishPipelineArtifact@1
          inputs: {artifactName: $(owbindir), targetPath: build/$(owbindir)}
  - stage: build
    displayName: "Build"
    jobs:
      - job: Linux
        pool:
          vmImage: 'ubuntu-latest'
        variables:
          group: linux
        steps:
        - task: DownloadPipelineArtifact@2
          inputs: {buildType: 'current', artifactName: $(owbindir), targetPath: build/$(owbindir)}
      - job: Windows
        timeoutInMinutes: 120
        pool:
          vmImage: 'vs2017-win2016'
        variables:
          group: windows
        steps:
        - task: DownloadPipelineArtifact@2
          inputs: {buildType: 'current', artifactName: $(owbindir), targetPath: build/$(owbindir)}
      - job: OSX
        timeoutInMinutes: 120
        pool:
          vmImage: 'macOS-latest'
        steps:
        - task: DownloadPipelineArtifact@2
          inputs: {buildType: 'current', artifactName: $(owbindir), targetPath: build/$(owbindir)}
  - stage: update
    displayName: "Update Build"
    jobs:
      - job: Linux
        pool:
          vmImage: 'ubuntu-latest'
        variables:
          group: linux
        steps:
        - task: DownloadPipelineArtifact@2
          inputs: {buildType: 'current', artifactName: $(owbindir), targetPath: build/$(owbindir)}
      - job: Windows
        pool:
          vmImage: 'vs2017-win2016'
        variables:
          group: windows
        steps:
        - task: DownloadPipelineArtifact@2
          inputs: {buildType: 'current', artifactName: $(owbindir), targetPath: build/$(owbindir)}
  - stage: tests
    displayName: "Tests"
    jobs:
      - job: Linux
        pool:
          vmImage: 'ubuntu-latest'
        variables:
          group: linux
      - job: Windows
        pool:
          vmImage: 'vs2017-win2016'
        variables:
          group: windows
  - stage: docs
    displayName: "Documentation Build"
    jobs:
      - job: Windows
        timeoutInMinutes: 120
        pool:
          vmImage: 'vs2017-win2016'
        variables:
          group: windows
  - stage: instal
    displayName: "Build Installers"
    jobs:
      - job: Linux
        pool:
          vmImage: 'ubuntu-latest'
        variables:
          group: linux
        steps:
        - task: DownloadPipelineArtifact@2
          inputs: {buildType: 'current', artifactName: $(owbindir), targetPath: build/$(owbindir)}
      - job: Windows
        pool:
          vmImage: 'vs2017-win2016'
        variables:
          group: windows
        steps:
        - task: DownloadPipelineArtifact@2
          inputs: {buildType: 'current', artifactName: $(owbindir), targetPath: build/$(owbindir)}
  - stage: release
    displayName: "Make Release on GitHub"
    jobs:
      - job: Linux
        pool:
          vmImage: 'ubuntu-latest'
        variables:
          group: linux
